{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 style="margin-bottom: 24px;">Orphanage Dashboard</h2>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar / Stats -->
        <div class="dashboard-sidebar" style="flex: 1;">
            <div class="card" style="margin-bottom: 24px;">
                <h3>Stats</h3>
                <div style="display: flex; gap: 24px; margin-top: 16px;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">{{ my_orders.count }}
                        </div>
                        <div>Orders Placed</div>
                    </div>
                </div>
            </div>

            <a href="{% url 'food_list' %}" class="btn"
                style="width: 100%; text-align: center; margin-bottom: 24px;">Find Food</a>
        </div>

        <!-- Main Content / Orders -->
        <div class="dashboard-main" style="flex: 2;">
            <div class="card">
                <h3 style="margin-bottom: 16px;">My Orders</h3>
                {% if my_orders %}
                <div class="table-responsive">
                    <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #eee; text-align: left;">
                                <th style="padding: 12px;">Food</th>
                                <th style="padding: 12px;">Donor</th>
                                <th style="padding: 12px;">Date</th>
                                <th style="padding: 12px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in my_orders %}
                            <tr style="border-bottom: 1px solid #f9f9f9;">
                                <td style="padding: 12px;">{{ order.food_post.title }}</td>
                                <td style="padding: 12px;">{{ order.food_post.donor.username }}</td>
                                <td style="padding: 12px;">{{ order.claimed_at|date:"M d" }}</td>
                                <td style="padding: 12px;">
                                    <span class="badge badge-hotel">{{ order.status }}</span>
                                    {% if order.status == 'PENDING' %}
                                    <br>
                                    <button onclick="showQr('{{ order.id }}', '{{ order.food_post.title }}')"
                                        class="btn-text"
                                        style="font-size: 0.8rem; color: var(--primary); cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0;">
                                        View Pickup Pass
                                    </button>
                                    <span style="margin: 0 4px; color: #ccc;">|</span>
                                    <a href="{% url 'withdraw_order' order.id %}"
                                        style="font-size: 0.8rem; color: #999;">Withdraw</a>
                                    {% elif order.status == 'COMPLETED' %}
                                    <br>
                                    <a href="{% url 'submit_feedback' order.id %}"
                                        style="font-size: 0.8rem; color: var(--secondary); text-decoration: underline;">Give
                                        Feedback</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>No orders yet. Browse food to make a claim.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- QR Modal -->
<div id="qrModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div
        style="background: white; padding: 40px; border-radius: 12px; text-align: center; position: relative; max-width: 90%; width: 400px;">
        <span onclick="document.getElementById('qrModal').style.display='none'"
            style="position: absolute; top: 10px; right: 20px; font-size: 2rem; cursor: pointer;">&times;</span>
        <h3 id="qrTitle" style="margin-bottom: 20px;">Pickup Pass</h3>
        <img id="qrImage" src="" alt="QR Code" style="width: 100%; max-width: 250px; margin-bottom: 20px;">
        <p style="color: #666; font-size: 0.9rem;">Show this to the hotel staff to confirm pickup.</p>
    </div>
</div>

<script>
    function showQr(orderId, title) {
        const modal = document.getElementById('qrModal');
        const img = document.getElementById('qrImage');
        const titleEl = document.getElementById('qrTitle');

        img.src = `/orders/qr/${orderId}/`;
        titleEl.innerText = `Pickup: ${title}`;
        modal.style.display = 'flex';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('qrModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}